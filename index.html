<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lawhive Co-counsel User Onboarding Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f7f8fa;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0f62fe;
      --accent-600: #0b53d6;
      --success: #10b981;
      --danger: #ef4444;
      --radius-lg: 14px;
      --radius-sm: 10px;
      --shadow: 0 8px 30px rgba(16,24,40,0.08);
      --max-width: 980px;
      --gap: 16px;
    }

    /* Reset / base */
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background-color: #FDE6D0; /* keep original warm background */
      color: #0f1724;
      padding: 40px 20px;
      -webkit-font-smoothing:antialiased;
    }

    h1{
      text-align:center;
      font-size:1.8rem;
      margin:0 0 18px 0;
      font-weight:800;
      color: #0b1220;
      letter-spacing: -0.2px;
    }

    /* Layout */
    .form-shell{
      max-width:var(--max-width);
      margin:0 auto;
      padding: 10px;
    }

    form{
      background: linear-gradient(180deg, var(--card), #fbfdff);
      border-radius:var(--radius-lg);
      padding:28px;
      box-shadow:var(--shadow);
      border: 1px solid rgba(15,23,36,0.06);
    }

    fieldset{border:0; padding:0; margin:0 0 22px 0}

    legend{
      font-weight:700;
      font-size:1rem;
      margin-bottom:12px;
      color:#0b1220;
    }

    /* Form grid for user info */
    .user-grid{display:grid; grid-template-columns: repeat(2, 1fr); gap:var(--gap); align-items:start}

    label{display:block; font-size:0.95rem; color: #0b1220}
    .muted { color: var(--muted); font-size:0.88rem }

    .field{width:100%}

    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select, textarea{
      width:100%;
      padding:12px 14px;
      border-radius:var(--radius-sm);
      border:1px solid rgba(15,23,36,0.08);
      background: #fff;
      transition: box-shadow .14s ease, border-color .14s ease, transform .06s ease;
      font-size:0.96rem;
    }

    textarea{min-height:72px}

    input:focus, select:focus, textarea:focus{outline:none; box-shadow:0 8px 30px rgba(15,99,255,0.06); border-color:var(--accent-600); transform:translateY(-1px)}

    /* Buttons */
    .btn{display:inline-flex; align-items:center; justify-content:center; background:var(--accent); color:#fff; border:0; padding:10px 18px; border-radius:12px; font-weight:700; cursor:pointer; box-shadow: 0 6px 18px rgba(11,83,214,0.08); transition:transform .08s ease, box-shadow .12s ease}
    .btn:hover{transform:translateY(-3px); box-shadow: 0 14px 30px rgba(11,83,214,0.12); background:var(--accent-600)}
    .btn-secondary{background:transparent; color:var(--accent-600); border:1px solid rgba(11,83,214,0.08); padding:8px 14px}

    /* Utility & small components */
    .hidden{display:none}
    .checkbox-label{display:flex; align-items:center; gap:10px;}
    .checkbox-label input{width:auto}

  /* Tighter parent/subcategory spacing and slightly reduced indentation */
  .category-group{margin-top:6px; padding:10px; border-radius:10px; background: linear-gradient(180deg, rgba(15,23,36,0.03), rgba(15,23,36,0.04)); border:1px solid rgba(15,23,36,0.06)}
  .subcategory-block{margin-top:6px; padding:8px 8px; border-radius:8px; background:rgba(255,255,255,0.78)}
  .children-block{margin-left:10px}

  /* Darken preference block background slightly for more contrast */
  .attorney-preferences {margin:14px 0 0 0; padding:14px; background:linear-gradient(180deg, rgba(15,23,36,0.06), rgba(15,23,36,0.04)); border-radius:8px; border:1px solid rgba(15,23,36,0.06)}
    .attorney-preferences p {margin:0 0 6px 0; font-weight:600}

    .preference-options {display:flex; flex-direction:column; gap:10px}
    .preference-options label{display:flex; gap:10px; align-items:center}

    .counties-field {margin-top:8px; margin-left:28px}
    .counties-field textarea {padding:10px 12px}

  .child-category-label{display:flex; gap:8px; align-items:center}
    .child-category-label input{width:auto}

    .jurisdiction-divider{height:1px; background:linear-gradient(90deg, rgba(15,23,36,0.04), rgba(15,23,36,0.02)); margin:14px 0}

    .jurisdiction-block{background:linear-gradient(180deg,#ffffff,#fbfdff); border:1px solid rgba(15,23,36,0.04); padding:16px; border-radius:12px; margin-bottom:16px; box-shadow: 0 6px 20px rgba(2,6,23,0.04)}

    .jurisdiction-top{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; align-items:end}

    .remove-jurisdiction-btn{background:none; border:0; color:var(--danger); font-weight:700; cursor:pointer}

    /* Checkbox accent color modern browsers */
    input[type="checkbox"]{width:18px; height:18px; accent-color:var(--accent)}

    /* Small helpers */
    .small-muted{font-size:0.86rem; color:var(--muted)}

    /* Responsive */
    @media (max-width:900px){ .user-grid{grid-template-columns:1fr} .jurisdiction-top{grid-template-columns:1fr} form{padding:20px} }
    @media (max-width:420px){ body{padding:18px} .btn{width:100%} }
  </style>
  <script>
    let subcategoriesMap = {};

    async function fetchCategoriesFromAirtable() {
      try {
        const response = await fetch("/.netlify/functions/getCategories");
        const map = await response.json();
        subcategoriesMap = map;
      } catch (err) {
        console.error("Failed to load categories from server", err);
      }
    }

    function toggleCountiesField(elementId, show) {
      const element = document.getElementById(elementId);
      if (element) {
        if (show) {
          element.classList.remove('hidden');
          // If a counties field is being shown, ensure the 'None' option for this parent is unchecked
          try {
            const parentId = elementId.split('-').slice(0, -2).join('-');
            const noneCb = document.querySelector(`input[name="none-${parentId}"]`);
            if (noneCb) noneCb.checked = false;
          } catch (e) {
            // ignore parsing issues
          }
        } else {
          element.classList.add('hidden');
          // Clear the textarea when hidden
          const textarea = element.querySelector('textarea');
          if (textarea) {
            textarea.value = '';
          }
        }
      }
    }

    async function toggleAttorneyFields() {
      const isAttorney = document.getElementById('isAttorney').checked;
      const isAttorneyNo = document.getElementById('isAttorneyNo');
      // Ensure mutual exclusivity
      if (isAttorney && isAttorneyNo) {
        isAttorneyNo.checked = false;
      }
      const attorneyFields = document.getElementById('attorneyFields');
      const dateAdmittedLabel = document.getElementById('dateAdmittedLabel');
      const jurisdictionContainer = document.getElementById('jurisdictionContainer');

      if (isAttorney) {
        attorneyFields.classList.remove('hidden');
        dateAdmittedLabel.classList.remove('hidden');
        jurisdictionContainer.innerHTML = '';

        if (!categoriesFetched) {
          await fetchCategoriesFromAirtable();
          categoriesFetched = true;
        }

        addJurisdictionField();
      } else {
        attorneyFields.classList.add('hidden');
        dateAdmittedLabel.classList.add('hidden');
        jurisdictionContainer.innerHTML = '';
      }
    }

    function removeJurisdictionField(button) {
      const allBlocks = document.querySelectorAll('.jurisdiction-block');
      if (allBlocks.length <= 1) {
        alert("At least one jurisdiction is required.");
        return;
      }

      const jurisdictionBlock = button.closest('.jurisdiction-block');
      if (jurisdictionBlock) {
        jurisdictionBlock.remove();
      }
    }
    
    function addJurisdictionField() {
      const isAttorney = document.getElementById('isAttorney').checked;
      const requiredAttr = isAttorney ? 'required' : '';
      const container = document.getElementById('jurisdictionContainer');
      const index = container.children.length + 1;

      const div = document.createElement('div');
      div.className = 'jurisdiction-block';
      div.setAttribute('data-index', index);
      console.log("ðŸ§ª subcategoriesMap", subcategoriesMap);
      div.innerHTML = `
        <div class="jurisdiction-divider"></div>
        <div class="jurisdiction-top">
          <label>Jurisdiction:
            <select name="jurisdiction${index}" ${requiredAttr}>
              <option disabled selected value="">Select your jurisdiction</option>
              <option>Alabama</option><option>Alaska</option><option>Arizona</option><option>Arkansas</option><option>California</option><option>Colorado</option><option>Connecticut</option><option>Delaware</option><option>District of Columbia</option><option>Florida</option><option>Georgia</option><option>Hawaii</option><option>Idaho</option><option>Illinois</option><option>Indiana</option><option>Iowa</option><option>Kansas</option><option>Kentucky</option><option>Louisiana</option><option>Maine</option><option>Maryland</option><option>Massachusetts</option><option>Michigan</option><option>Minnesota</option><option>Mississippi</option><option>Missouri</option><option>Montana</option><option>Nebraska</option><option>Nevada</option><option>New Hampshire</option><option>New Jersey</option><option>New Mexico</option><option>New York</option><option>North Carolina</option><option>North Dakota</option><option>Ohio</option><option>Oklahoma</option><option>Oregon</option><option>Pennsylvania</option><option>Rhode Island</option><option>South Carolina</option><option>South Dakota</option><option>Tennessee</option><option>Texas</option><option>Utah</option><option>Vermont</option><option>Virginia</option><option>Washington</option><option>West Virginia</option><option>Wisconsin</option><option>Wyoming</option><option>American Samoa</option><option>Guam</option><option>Northern Mariana Islands</option><option>Puerto Rico</option><option>U.S. Virgin Islands</option>
            </select>
          </label>
          <label>Bar Number:
            <input type="text" name="barNumber${index}" ${requiredAttr}>
          </label>
          ${index === 1 ? `<label>Patent License Number:<input type="text" name="patentLicense"></label>` : ''}
        </div>
        <p>
          <strong>Select services for this jurisdiction:</strong>
          (Federal services should only be selected for the first jurisdiction)<br>
          <a href="https://docs.google.com/spreadsheets/d/1fK4PtwzajaIWz5maWKXiFa7k4F2O3bbpPS3VRAvWbAM/edit?gid=0#gid=0" target="_blank" rel="noopener noreferrer">
            Click here to view the full scope and price for each product
          </a>
        </p>
        ${Object.entries(subcategoriesMap).map(([parentCategory, subcategories]) => {
          const parentId = `parent-${parentCategory.replace(/[^a-zA-Z0-9]/g, '')}-${index}`;
          return `
            <div class="category-group">
              <label>
                <input 
                  type="checkbox" 
                  id="${parentId}"
                  name="parentCategory-${index}" 
                  value="${parentCategory}" 
                  onchange="toggleParent('${parentId}', ${index})"
                > <strong>${parentCategory}</strong>
              </label>
              <div id="${parentId}-children" class="children-block hidden">
                ${Object.entries(subcategories).map(([subcategory, products]) => {
                  const subId = `subcategory-${subcategory.replace(/[^a-zA-Z0-9]/g, '')}-${index}`;
                  return `
                    <div class="subcategory-block">
                      <label>
                        <input 
                          type="checkbox" 
                          id="${subId}" 
                          name="subcategory-${index}" 
                          value="${subcategory}" 
                          onchange="toggleSubcategory('${subId}', ${index})"
                        > ${subcategory}
                      </label>
                      <div id="${subId}-children" class="children-block hidden">
                        ${products.map(product => `
                          <label class="child-category-label">
                            <input 
                              type="checkbox" 
                              name="child${index}" 
                              value="${product}" 
                              data-category="${parentCategory}" 
                              data-subcategory="${subcategory}"
                            > ${product}
                          </label>
                        `).join('')}
                      </div>
                    </div>
                  `;
                }).join('')}

                  <!-- Attorney preferences moved BELOW subcategories -->
                  <div class="attorney-preferences">
                    <p><strong>Are you open to:</strong></p>
                    <div class="preference-options">
                      <label>
                        <input type="checkbox" 
                               name="courtAppearances-${parentId}" 
                               onchange="(function(ch){ toggleCountiesField('${parentId}-court-counties', ch); if(ch) toggleNonePreference('${parentId}', false); })(this.checked)"> 
                        Making court appearances
                      </label>
                      <div id="${parentId}-court-counties" class="counties-field hidden">
                        <textarea 
                          name="courtCounties-${parentId}" 
                          placeholder="Counties/parishes where you can appear (comma separated, e.g. Travis County, Harris County, Dallas County)"
                          rows="3"
                        ></textarea>
                      </div>
                      <label>
                        <input type="checkbox" 
                               name="fullRepresentation-${parentId}" 
                               onchange="(function(ch){ toggleCountiesField('${parentId}-full-counties', ch); if(ch) toggleNonePreference('${parentId}', false); })(this.checked)"> 
                        Taking on full representation
                      </label>
                      <div id="${parentId}-full-counties" class="counties-field hidden">
                        <textarea 
                          name="representationCounties-${parentId}" 
                          placeholder="Counties/parishes where you can represent (comma separated, e.g. Travis County, Harris County, Dallas County)"
                          rows="3"
                        ></textarea>
                      </div>
                      <label>
                        <input type="checkbox"
                               name="none-${parentId}"
                               onchange="toggleNonePreference('${parentId}', this.checked)">
                        None
                      </label>
                    </div>
                  </div>
              </div>
            </div>
          `;
        }).join('')}

        



        
        ${index > 1 ? `
          <div class="remove-btn-wrapper">
            <button 
              type="button" 
              class="remove-jurisdiction-btn" 
              onclick="removeJurisdictionField(this)">
              Remove This Jurisdiction
            </button>
          </div>
        ` : ''}
        `;

      container.appendChild(div);
    }

    function toggleParent(parentId, index) {
      const parentCheckbox = document.getElementById(parentId);
      const isChecked = parentCheckbox.checked;
      const children = document.getElementById(`${parentId}-children`);

      if (children) {
        if (isChecked) children.classList.remove('hidden');
        else children.classList.add('hidden');
      }

      // Uncheck and collapse all subcategories and children if unchecked
      if (!isChecked) {
        const subcategoryCheckboxes = children.querySelectorAll(`input[name="subcategory-${index}"]`);
        subcategoryCheckboxes.forEach(subCb => {
          subCb.checked = false;

          const subId = subCb.id;
          const serviceBlock = document.getElementById(`${subId}-children`);
          if (serviceBlock) {
            serviceBlock.classList.add('hidden');
            serviceBlock.querySelectorAll('input[type="checkbox"]').forEach(childCb => {
              childCb.checked = false;
            });
          }
        });
      }
    }

    function toggleSubcategory(subId, index) {
      const isChecked = document.getElementById(subId).checked;
      const serviceBlock = document.getElementById(`${subId}-children`);
      if (serviceBlock) {
        if (isChecked) serviceBlock.classList.remove('hidden');
        else serviceBlock.classList.add('hidden');

        serviceBlock.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = isChecked;
        });
      }
    }

    // Preference helpers
    function toggleNonePreference(parentId, checked) {
      // when None is checked, uncheck court/full and hide their county fields
      const courtCb = document.querySelector(`input[name="courtAppearances-${parentId}"]`);
      const fullCb = document.querySelector(`input[name="fullRepresentation-${parentId}"]`);
      const courtWrapper = document.getElementById(`${parentId}-court-counties`);
      const fullWrapper = document.getElementById(`${parentId}-full-counties`);

      if (checked) {
        if (courtCb) { courtCb.checked = false; }
        if (fullCb) { fullCb.checked = false; }
        if (courtWrapper) { courtWrapper.classList.add('hidden'); const t=courtWrapper.querySelector('textarea'); if(t) t.value=''; }
        if (fullWrapper) { fullWrapper.classList.add('hidden'); const t=fullWrapper.querySelector('textarea'); if(t) t.value=''; }
      }
      // if None is unchecked, do nothing special â€” user can check other boxes
    }

  </script>
</head>
<body>
  <div class="form-shell">
  <h1>Lawhive Co-counsel User Onboarding Form</h1>
  <form id="attorneyForm">
    <fieldset>
      <legend>User Information</legend>
      <div class="user-grid">
        <div>
          <div style="display: flex; gap: 16px; align-items: center;">
            <span>Are you an attorney?</span>
            <label class="checkbox-label">
              <span>Yes</span>
              <input
                type="checkbox"
                name="isAttorney"
                id="isAttorney"
                onchange="toggleAttorneyFields()"
              >
            </label>
            <label class="checkbox-label">
              <span>No</span>
              <input
                type="checkbox"
                name="isAttorneyNo"
                id="isAttorneyNo"
                onchange="if(this.checked) { document.getElementById('isAttorney').checked = false; toggleAttorneyFields(); }"
              >
            </label>
          </div>
        </div>
        <div></div>

        <div class="field">
          <label>First Name</label>
          <input type="text" name="firstName" required>
        </div>
        <div class="field">
          <label>Last Name</label>
          <input type="text" name="lastName" required>
        </div>

        <div class="field">
          <label>Email</label>
          <input type="email" name="email" required>
        </div>
        <div class="field">
          <label>Office Phone</label>
          <input type="tel" name="office phone">
        </div>

        <div class="field">
          <label>Cell Phone</label>
          <input type="tel" name="cell phone">
        </div>

        <div class="field hidden" id="dateAdmittedLabel">
          <label>Date First Admitted to Bar</label>
          <input type="date" name="dateAdmitted" id="dateAdmitted">
        </div>

        <div class="field">
          <label>Firm Name</label>
          <input type="text" name="firmName" required>
        </div>
        <div class="field">
          <label>Job Title</label>
          <input type="text" name="jobTitle" required>
        </div>
      </div>
    </fieldset>

    <div id="attorneyFields" class="hidden">
      <fieldset>
        <legend>Jurisdiction and Services</legend>
        <div id="jurisdictionContainer"></div>
        <button type="button" onclick="addJurisdictionField()">Add Another Jurisdiction</button>
      </fieldset>
    </div>
    <button type="submit" id="submitBtn">Submit</button>
  </form>
<script>
  let isSubmitting = false;
  let categoriesFetched = false;

  window.addEventListener("DOMContentLoaded", async () => {
    // Ensure categories are loaded on page load
    await fetchCategoriesFromAirtable();
    categoriesFetched = true;

    // Prefill jurisdiction fields if attorney box is already checked
    if (document.getElementById("isAttorney").checked) {
      toggleAttorneyFields();
    }
  });

document.getElementById("attorneyForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      if (isSubmitting) return;
      isSubmitting = true;

      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      submitBtn.innerText = "Submitting...";

    const formData = new FormData(e.target);

    const userFields = {
      firstName: formData.get("firstName"),
      lastName: formData.get("lastName"),
      email: formData.get("email"),
      officePhone: formData.get("office phone"),      
      cellPhone: formData.get("cell phone"),  
      isAttorney: formData.get("isAttorney") === "on",
      firmName: formData.get("firmName"),
      jobTitle: formData.get("jobTitle")
    };


    const dateAdmittedValue = formData.get("dateAdmitted");
    if (dateAdmittedValue) {
      userFields.dateAdmitted = dateAdmittedValue;
    }

    const jurisdictionBlocks = document.querySelectorAll(".jurisdiction-block");
    const jurisdictionPayloads = [];

    for (const block of jurisdictionBlocks) {
      const index = block.getAttribute("data-index");

      const jurisdiction = block.querySelector(`select[name="jurisdiction${index}"]`)?.value || "";
      const barNumber = block.querySelector(`input[name="barNumber${index}"]`)?.value || "";
      const patentLicense = block.querySelector(`input[name="patentLicense"]`)?.value || "";
      const services = Array.from(block.querySelectorAll(`input[name="child${index}"]:checked`)).map(cb => {
        const category = cb.dataset.category;
        const parentId = `parent-${category.replace(/[^a-zA-Z0-9]/g, '')}-${index}`;
        const courtAppearancesCheckbox = block.querySelector(`input[name="courtAppearances-${parentId}"]`);
        const fullRepCheckbox = block.querySelector(`input[name="fullRepresentation-${parentId}"]`);
        
        return {
          product: cb.value,
          category: category,
          subcategory: cb.dataset.subcategory,
          courtAppearances: courtAppearancesCheckbox?.checked || false,
          courtCounties: courtAppearancesCheckbox?.checked ? 
            block.querySelector(`textarea[name="courtCounties-${parentId}"]`)?.value || '' : '',
          fullRepresentation: fullRepCheckbox?.checked || false,
          none: block.querySelector(`input[name="none-${parentId}"]`)?.checked || false,
          representationCounties: fullRepCheckbox?.checked ?
            block.querySelector(`textarea[name="representationCounties-${parentId}"]`)?.value || '' : ''
        };
      });
      if (!jurisdiction) continue;

      jurisdictionPayloads.push({
        jurisdiction,
        barNumber,
        patentLicense,
        services
      });
    }

    // Validation: for each jurisdiction, any selected parent category must have at least one preference selected
    const jurisdictionBlocksForValidation = Array.from(document.querySelectorAll('.jurisdiction-block'));
    for (const block of jurisdictionBlocksForValidation) {
      const idx = block.getAttribute('data-index');
      const checkedParents = Array.from(block.querySelectorAll(`input[name="parentCategory-${idx}"]:checked`));
      for (const parentCb of checkedParents) {
        const parentId = parentCb.id;
        const parentName = parentCb.value || 'Selected category';
        const court = block.querySelector(`input[name="courtAppearances-${parentId}"]`);
        const full = block.querySelector(`input[name="fullRepresentation-${parentId}"]`);
        const nonePref = block.querySelector(`input[name="none-${parentId}"]`);
        if (!(court?.checked || full?.checked || nonePref?.checked)) {
          // re-enable UI and stop submission
          alert(`Please select at least one option (Appearance, Full Representation, or None) for "${parentName}" in jurisdiction ${idx}.`);
          submitBtn.disabled = false;
          submitBtn.innerText = 'Submit';
          isSubmitting = false;
          return;
        }
      }
    }

    try {
      const payload = { userFields };

      if (userFields.isAttorney) {
        payload.jurisdictionPayloads = jurisdictionPayloads;
      }

      const response = await fetch("/.netlify/functions/submitForm", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error("Webhook failed");

      alert("Form submitted successfully!");
      e.target.reset();
  document.getElementById("jurisdictionContainer").innerHTML = "";
  document.getElementById("attorneyFields").classList.add('hidden');
  document.getElementById("dateAdmittedLabel").classList.add('hidden');
      document.getElementById("isAttorney").checked = false;
      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit";
    } catch (error) {
      console.error("Submission error:", error);
      alert("There was an error submitting the form. Please try again.");
      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit";
    }
  });
</script>
